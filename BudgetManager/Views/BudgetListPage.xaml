<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="BudgetManager.Views.BudgetPage"
    xmlns:vm="clr-namespace:BudgetManager.ViewModels"
    Title="Budgets">

    <Grid RowDefinitions="Auto,*,Auto">
        <Grid Style="{StaticResource PageHeader}" ColumnDefinitions="Auto,*,Auto">
            <HorizontalStackLayout>
                <Button
                    Text="◀"
                    BackgroundColor="Transparent"
                    FontSize="20"
                    Padding="0,0,10,0"
                    Command="{Binding PreviousMonthCommand}"/>

                <Label Text="{Binding MonthDisplay}"
                   TextColor="White"
                   FontSize="18"
                   VerticalOptions="Center" />

                <!-- Next Month Button -->
                <Button
                    Text="▶"
                    BackgroundColor="Transparent"
                    FontSize="20"
                    Padding="0"
                    Command="{Binding NextMonthCommand}"/>
            </HorizontalStackLayout>

            <HorizontalStackLayout Grid.Column="1" HorizontalOptions="End">
                <ImageButton Grid.Column="2" 
                     Source="plus.png" 
                     HeightRequest="24"
                     WidthRequest="24"
                     Margin="0,0,10,0"
                     BackgroundColor="Transparent"
                     Command="{Binding Source={RelativeSource AncestorType={x:Type vm:CategoryViewModel}}, Path=EditCategoryCommand}"
                     CommandParameter="{Binding .}" />
            </HorizontalStackLayout>
        </Grid>

        <Grid Grid.Row="1" Style="{StaticResource PageBody}" Padding="12">
            <!-- Main Content Area -->
            <ScrollView>
                <VerticalStackLayout Spacing="15">

                    <!-- Summary Card -->
                    <Border Style="{StaticResource Card}">
                        <Grid ColumnDefinitions="*,*,*">
                            <VerticalStackLayout>
                                <Label Text="Total"/>
                                <Label Text="{Binding TotalBudget, StringFormat='৳ {0:F2}'}" TextColor="#4FC3F7" FontSize="16"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="1" HorizontalOptions="Center">
                                <Label Text="Expenses"/>
                                <Label Text="{Binding TotalSpent, StringFormat='৳ {0:F2}'}" TextColor="White" FontSize="16"/>
                            </VerticalStackLayout>

                            <VerticalStackLayout Grid.Column="2" HorizontalOptions="End">
                                <Label Text="Remaining"/>
                                <Label Text="{Binding TotalSpent, StringFormat='৳ {0:F2}'}" TextColor="White" FontSize="16"/>
                            </VerticalStackLayout>
                        </Grid>
                    </Border>

                    <!-- Budget List -->
                    <CollectionView ItemsSource="{Binding Budgets}">
                        <CollectionView.EmptyView>
                            <Label Text="No budgets yet. Tap the + button to create one!" 
                               FontSize="16"
                               TextColor="Gray"
                               HorizontalOptions="Center"
                               VerticalOptions="Center"
                               Margin="0,50,0,0" />
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <VerticalStackLayout>
                                    <Border StrokeThickness="0" Padding="0,12">
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:BudgetViewModel}}, Path=GoToBudgetDetailsCommand}"
                                                          CommandParameter="{Binding .}" />
                                        </Border.GestureRecognizers>
                                        <Grid ColumnDefinitions="*,Auto,*" RowDefinitions="Auto,Auto,Auto,Auto">
                                            <!-- Budget Name -->
                                            <Label Grid.Row="0" Grid.Column="0"
                                               Text="{Binding Name}" 
                                               FontSize="18" 
                                               FontAttributes="Bold" />

                                            <!-- Budget Amount -->
                                            <Label Grid.Row="0" Grid.Column="2"
                                               Text="{Binding Amount, StringFormat='৳ {0:F2}'}" 
                                               FontSize="18" 
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource Primary}"
                                               HorizontalOptions="End" />

                                            <!-- Progress Bar -->
                                            <ProgressBar Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="3"
                                                 Progress="{Binding ProgressPercentage}" />

                                            <!-- Spent and Remaining Labels (Below Progress Bar) -->
                                            <Label Grid.Row="2" Grid.Column="0"
                                               Text="{Binding FormattedSpent}"
                                               FontSize="12"
                                               TextColor="{StaticResource TextSecondary}"
                                               HorizontalOptions="Start"/>

                                            <Label Grid.Row="2" Grid.Column="1"
                                               Text="{Binding FormattedPercentage}"
                                               FontSize="12"
                                               FontAttributes="Bold"
                                               TextColor="{StaticResource TextSecondary}"
                                               HorizontalOptions="Center"
                                               Margin="0,0,0,2" />

                                            <Label Grid.Row="2" Grid.Column="2"
                                               Text="{Binding FormattedRemaining}"
                                               FontSize="12"
                                               TextColor="{StaticResource TextSecondary}"
                                               HorizontalOptions="End" />
                                        </Grid>
                                    </Border>

                                    <BoxView HeightRequest="0.1"
                                    BackgroundColor="{DynamicResource Divider}"/>
                                </VerticalStackLayout>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </ScrollView>

            <!-- Floating Action Button -->
            <Button Text="+"
                Style="{StaticResource Fab}"
                Command="{Binding GoToAddBudgetCommand}" />
        </Grid>
    </Grid>
</ContentPage>